name: Deploy to Server

# Ce workflow se dÃ©clenche aprÃ¨s la publication d'une image Docker
# et dÃ©ploie l'application sur un serveur distant via SSH.
on:
  workflow_run:
    workflows: ["Publish Docker image"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      # Ã‰tapeÂ 1Â : Charger la clÃ© privÃ©e SSH Ã  partir des secrets
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # Ã‰tapeÂ 2Â : Ajouter l'hÃ´te au fichier known_hosts
      - name: Add known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      # Ã‰tapeÂ 3Â : DÃ©ployer l'application via SSH
      - name: Deploy container on remote host
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/flask-ci-cd-demo
        run: |
          ssh -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} <<'EOSSH'
            # Connexion au registre Docker
            echo "Connexion au registre Docker"
            echo ${DOCKER_PASSWORD} | docker login -u ${DOCKER_USERNAME} --password-stdin
            # RÃ©cupÃ©ration de la derniÃ¨re image
            docker pull ${IMAGE_NAME}:latest
            # ArrÃªt et suppression du conteneur existant si prÃ©sent
            docker stop flask-app || true
            docker rm flask-app || true
            # Lancement du nouveau conteneur
            docker run -d --name flask-app -p 5000:5000 ${IMAGE_NAME}:latest
          EOSSH

      # Ã‰tapeÂ 4Â : (optionnel) notification via Slack ou Discord
      - name: Notify deployment
        if: ${{ env.SLACK_WEBHOOK_URL != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"DÃ©ploiement terminÃ© avec succÃ¨s ðŸš€"}' ${SLACK_WEBHOOK_URL}